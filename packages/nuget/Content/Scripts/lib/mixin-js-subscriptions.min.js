/*
  mixin-js-subscriptions.js 0.1.5
  (c) 2011, 2012 Kevin Malakoff - http://kmalakoff.github.com/mixin/
  License: MIT (http://www.opensource.org/licenses/mit-license.php)
  Dependencies: Mixin.Core
*/(function(){return function(e){return typeof define=="function"&&define.amd?define("mixin-js-subscriptions",["mixin-js"],e):e.call(this)}(function(){var e,t;return e=!window.Mixin&&typeof require!="undefined"?require("mixin-js"):window.Mixin,t=e._,e.Subscriptions||(e.Subscriptions={}),e.Subscriptions._SubscriptionLink=function(){function n(n,r,i,s){var o;this.subscription=n,this.subscriber=r,this.notification_callback=i,this.options=t.clone(s||{}),o=e.instanceData(this.subscriber,"Subscriber"),o.subscription_backlinks.push(this)}return n.prototype.mustKeepUntilDestroyed=function(){return this.options.keep_until_destroyed===void 0||!this.options.keep_until_destroyed},n.prototype.destroy=function(){var n;if(!this.subscription)throw new Error("Mixin.Subscriptions: _SubscriptionLink destroyed multiple times");return this.options.destroy&&(this.options.destroy(),this.options.destroy=null),n=e.instanceData(this.subscriber,"Subscriber"),t.remove(n.subscription_backlinks,this),t.remove(this.subscription.subscription_links,this),this.subscription=null,this.subscriber=null,this.notification_callback=null,this.options=null},n}(),e.Subscription||(e.Subscription={}),e.Subscription.TYPE={},e.Subscription.TYPE.MULTIPLE=0,e.Subscription.TYPE.EXCLUSIVE=1,e.Subscriptions._Subscription=function(){function n(t,n){this.observable=t,this.subscription_type=n;if(e.DEBUG)if(typeof this.subscription_type!="number"||this.subscription_type<e.Subscription.TYPE.MULTIPLE||this.subscription_type>e.Subscription.TYPE.EXCLUSIVE)throw new Error("Mixin.Subscriptions: Mixin.Subscription.TYPE is invalid");this.subscription_links=[]}return n.prototype.addSubscriber=function(t,n,r){return this.subscription_type===e.Subscription.TYPE.EXCLUSIVE&&this.removeSubscribers(function(e){return e.mustKeepUntilDestroyed()}),this.subscription_links.push(new e.Subscriptions._SubscriptionLink(this,t,n,r))},n.prototype.removeSubscriber=function(e,n,r){var i;i=t.find(this.subscription_links,function(t){return e===t.subscriber&&n===t.notification_callback});if(!i)throw new Error("Mixin.Subscriptions.removeSubscriber: subscription '"+r+"' does not exist for '"+t.classOf(e)+"'");return t.remove(this.subscription_links,i),i.destroy()},n.prototype.subscribers=function(e){var t,n,r,i;i=this.subscription_links;for(n=0,r=i.length;n<r;n++)t=i[n],e.push(t.subscriber)},n.prototype.notifySubscribers=function(){var e,t,n,r,i;e=Array.prototype.slice.call(arguments),i=this.subscription_links;for(n=0,r=i.length;n<r;n++)t=i[n],t.notification_callback.apply(t.subscriber,e)},n.prototype.removeSubscribers=function(e){var n,r,i,s,o,u;if(e){n=t.select(this.subscription_links,e);if(n.length===0)return;this.subscription_links=t.difference(this.subscription_links,n);for(i=0,o=n.length;i<o;i++)r=n[i],r.destroy()}else{n=this.subscription_links,this.subscription_links=[];for(s=0,u=n.length;s<u;s++)r=n[s],r.destroy()}},n.prototype.destroy=function(){var e,t,n,r;t=this.subscription_links,this.subscription_links=[];for(n=0,r=t.length;n<r;n++)e=t[n],e.destroy()},n}(),e.Subscriptions.Observable||(e.Subscriptions.Observable={}),e.Subscriptions.Observable._mixin_info={mixin_name:"Observable",initialize:function(){var n,r,i;e.instanceData(this,"Observable",{subscriptions:{},is_destroyed:!1});for(r=0,i=arguments.length;r<i;r++)n=arguments[r],this.publishSubscription.apply(this,t.isArray(n)?n:[n])},destroy:function(){var t,n,r,i,s;t=e.instanceData(this,"Observable");if(t.is_destroyed)throw new Error("Mixin.Observable.destroy: already destroyed");t.is_destroyed=!0,r=t.subscriptions,t.subscriptions=[];for(i=0,s=r.length;i<s;i++)n=r[i],n.destroy()},mixin_object:{hasSubscription:function(t){var n;return e.DEBUG&&e.Core._Validate.string(t,"Mixin.Observable.hasSubscription","subscription_name"),n=e.instanceData(this,"Observable"),n.subscriptions.hasOwnProperty(t)},publishSubscription:function(t,n){var r;return r=e.instanceData(this,"Observable"),n===void 0&&(n=e.Subscription.TYPE.MULTIPLE),e.DEBUG&&(e.Core._Validate.string(t,"Mixin.Observable.publishSubscription","subscription_name"),e.Core._Validate.noKey(r.subscriptions,t,"Mixin.Observable.publishSubscription","subscription_name")),r.subscriptions[t]=new e.Subscriptions._Subscription(this,n),this},subscriptions:function(){var t,n,r,i,s;t=e.instanceData(this,"Observable"),r=[],s=t.subscriptions;for(n in s)i=s[n],r.push(n);return r},subscribers:function(n){var r,i,s,o,u,a;s=[],r=e.instanceData(this,"Observable");if(n===void 0){u=r.subscriptions;for(i in u)o=u[i],o.subscribers(s)}else{if(!r.subscriptions.hasOwnProperty(n))throw new Error("Mixin.Observable.subscribers: subscriber '"+_classOf(this)+"' does not recognize '"+n+"'");a=r.subscriptions;for(i in a)o=a[i],o.subscription_name===n&&o.subscribers(s)}return t.uniq(s)},addSubscriber:function(n,r){var i,s,o,u,a,f,l;o=e.instanceData(this,"Observable"),a=function(t,r,i){var s;return i||(i={}),e.DEBUG&&(e.Core._Validate.string(t,"Mixin.Observable.addSubscriber","subscription_name"),e.Core._Validate.callback(r,"Mixin.Observable.addSubscriber","notification_callback"),e.Core._Validate.object(i,"Mixin.Observable.addSubscriber","options"),i.destroy!==void 0&&e.Core._Validate.callback(i.destroy,"Mixin.Observable.addSubscriber","options.destroy")),e.Core._Validate.hasKey(o.subscriptions,t,"Mixin.Observable.addSubscriber","subscription_name"),s=o.subscriptions[t],s.addSubscriber(n,r,i)},i=Array.prototype.slice.call(arguments,1),e.Core._Validate.instanceWithMixin(n,"Subscriber","Mixin.Observable.addSubscriber","subscriber");if(i.length>1){s=i[1];if(!(t.isString(s)&&this.hasSubscription(s)||t.isArray(s)&&s.length>=1&&t.isString(s[0])&&this.hasSubscription(s[0])))return a.apply(this,Array.prototype.slice.call(arguments,1)),this}for(f=0,l=i.length;f<l;f++)u=i[f],t.isArray(u)?a.apply(this,u):a.apply(u);return this},notifySubscribers:function(t){var n,r;n=e.instanceData(this,"Observable");if(n.is_destroyed)return;e.DEBUG&&(e.Core._Validate.string(t,"Mixin.Observable.notifySubscribers","subscription_name"),e.Core._Validate.hasKey(n.subscriptions,t,"Mixin.Observable.notifySubscribers")),r=n.subscriptions[t];if(!r)return;return r.notifySubscribers.apply(r,Array.prototype.slice.call(arguments,1)),this},removeSubscriber:function(n,r,i){var s,o,u,a,f,l,c;u=e.instanceData(this,"Observable"),f=function(t,r){var i;return e.DEBUG&&(e.Core._Validate.string(t,"Mixin.Observable.removeSubscriber","subscription_name"),e.Core._Validate.callback(r,"Mixin.Observable.removeSubscriber","notification_callback")),e.Core._Validate.hasKey(u.subscriptions,t,"Mixin.Observable.removeSubscriber","subscription_name"),i=u.subscriptions[t],i.removeSubscriber(n,r,t)},s=Array.prototype.slice.call(arguments,1),e.DEBUG&&e.Core._Validate.instanceWithMixin(n,"Subscriber","Mixin.Observable.removeSubscriber","subscriber");if(s.length>1){o=s[1];if(!(t.isString(o)&&this.hasSubscription(o)||t.isArray(o)&&o.length>=1&&t.isString(o[0])&&this.hasSubscription(o[0])))return f.apply(this,Array.prototype.slice.call(arguments,1)),this}for(l=0,c=s.length;l<c;l++)a=s[l],t.isArray(a)?f.apply(this,a):f.apply(a);return this},removeSubscribers:function(t,n){var r,i,s,o;r=e.instanceData(this,"Observable"),e.DEBUG&&(t!==void 0&&(e.Core._Validate.string(t,"Mixin.Observable.removeSubscribers","subscription_name"),e.Core._Validate.hasKey(r.subscriptions,t,"Mixin.Observable.removeSubscribers")),n!==void 0&&e.Core._Validate.callback(n,"Mixin.Observable.removeSubscribers","test_fn"));if(t){s=r.subscriptions[t];if(!s)return;s.removeSubscribers(n)}else{o=r.subscriptions;for(i in o)s=o[i],s.removeSubscribers(n)}return this}}},e.Subscriptions.Subscriber||(e.Subscriptions.Subscriber={}),e.Subscriptions.Subscriber._mixin_info={mixin_name:"Subscriber",initialize:function(){return e.instanceData(this,"Subscriber",{subscription_backlinks:[],is_destroyed:!1})},destroy:function(){var t,n,r,i,s;r=e.instanceData(this,"Subscriber");if(r.is_destroyed)throw new Error("Mixin.Subscriber.destroy: already destroyed");r.is_destroyed=!0,n=r.subscription_backlinks,r.subscription_backlinks=[];for(i=0,s=n.length;i<s;i++)t=n[i],t.destroy()},mixin_object:{observables:function(n){var r,i,s,o,u,a,f,l,c;r=e.instanceData(this,"Subscriber"),i=[];if(n===void 0){l=r.subscription_backlinks;for(o=0,a=l.length;o<a;o++)s=l[o],s.subscription&&s.subscription.subscription_name===n&&i.push(s.subscription.observable)}else{e.DEBUG&&e.Core._Validate.string(n,"Mixin.Subscriptions.observables","subscription_name"),c=r.subscription_backlinks;for(u=0,f=c.length;u<f;u++)s=c[u],s.subscription&&i.push(s.subscription.observable)}return t.uniq(i)}}},e.Subscriptions.ObservableSubscriber||(e.Subscriptions.ObservableSubscriber={}),e.Subscriptions.ObservableSubscriber._mixin_info={mixin_name:"ObservableSubscriber",mixin_object:{},initialize:function(){return e["in"](this,"Subscriber",["Observable"].concat(Array.prototype.slice.call(arguments)))},destroy:function(){return e.out(this,"Subscriber","Observable")}},e.registerMixin(e.Subscriptions.Observable._mixin_info),e.registerMixin(e.Subscriptions.Subscriber._mixin_info),e.registerMixin(e.Subscriptions.ObservableSubscriber._mixin_info),e})}).call(this);