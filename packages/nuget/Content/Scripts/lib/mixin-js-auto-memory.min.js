/*
  mixin-js-auto-memory.js 0.1.5
  (c) 2011, 2012 Kevin Malakoff - http://kmalakoff.github.com/mixin/
  License: MIT (http://www.opensource.org/licenses/mit-license.php)
  Dependencies: Mixin.Core
*/(function(){return function(e){return typeof define=="function"&&define.amd?define("mixin-js-auto-memory",["mixin-js"],e):e.call(this)}(function(){var e,t,n;return e=!window.Mixin&&typeof require!="undefined"?require("mixin-js"):window.Mixin,n=e._,t=this,e.AutoMemory||(e.AutoMemory={}),e.AutoMemory.Property=function(){function t(e){this.owner=e}return t.prototype.setArgs=function(){var t,r,i,s;if(!arguments.length)throw new Error("Mixin.AutoMemory: missing key");this.args=Array.prototype.slice.call(arguments);if(!e.DEBUG)return this;if(n.isArray(this.args[0])){s=this.args;for(r=0,i=s.length;r<i;r++)t=s[r],this._validateEntry(t)}else this._validateEntry(this.args)},t.prototype.destroy=function(){var e,t,r,i;if(n.isArray(this.args[0])){i=this.args;for(t=0,r=i.length;t<r;t++)e=i[t],this._destroyEntry(e)}else this._destroyEntry(this.args)},t.prototype._validateEntry=function(e){var t,r;r=e[0],t=e.length>1?e[1]:void 0;if(!n.keypathExists(this.owner,r))throw new Error("Mixin.AutoMemory: property '"+r+"' doesn't exist on '"+n.classOf(this.owner)+"'");if(t&&!n.isFunction(t)&&!n.isString(t))throw new Error("Mixin.AutoMemory: unexpected function reference for property '"+r+"' on '"+n.classOf(this.owner)+"'")},t.prototype._destroyEntry=function(e){var t,r,i,s,o,u,a,f;r=e[0],t=e.length>1?e[1]:void 0;if(!t){i=n.keypathValueOwner(this.owner,r);if(!i)throw new Error("Mixin.AutoMemory: property '"+r+"' doesn't exist on '"+n.classOf(this.owner)+"'");i[r]=null;return}o=n.keypath(this.owner,r);if(!o)return;if(n.isFunction(t))t.apply(this.owner,[o].concat(e.length>2?e.slice(2):[]));else if(n.isFunction(o[t]))o[t].apply(o,e.length>2?e.slice(2):[]);else{f=e.slice(1);for(u=0,a=f.length;u<a;u++)s=f[u],this._destroyEntry([s])}return n.keypath(this.owner,r,null)},t}(),e.AutoMemory.WrappedProperty=function(){function r(t,r,i,s){var o,u,a;this.owner=t,this.key=r,this.fn_ref=i,this.wrapper=s;if(this.fn_ref&&n.isArray(this.fn_ref)){if(e.DEBUG&&!this.fn_ref.length)throw new Error("Mixin.AutoMemory: unexpected function reference");this.args=this.fn_ref.splice(1),this.fn_ref=this.fn_ref[0]}if(!e.DEBUG)return this;if(!this.key)throw new Error("Mixin.AutoMemory: missing key");if(n.isArray(this.key)){a=this.key;for(o=0,u=a.length;o<u;o++){r=a[o];if(!n.keypathExists(this.owner,r))throw new Error("Mixin.AutoMemory: property '"+r+"' doesn't exist on '"+n.classOf(this.owner)+"'")}}else if(!n.keypathExists(this.owner,this.key))throw new Error("Mixin.AutoMemory: property '"+this.key+"' doesn't exist on '"+n.classOf(this.owner)+"'");if(this.fn_ref&&!n.isFunction(this.fn_ref)&&!n.isString(this.fn_ref))throw new Error("Mixin.AutoMemory: unexpected function reference");if(!this.wrapper)throw new Error("Mixin.AutoMemory: missing wrapper")}return r.prototype.destroy=function(){var e,t,r,i;if(n.isArray(this.key)){i=this.key;for(t=0,r=i.length;t<r;t++)e=i[t],this._destroyKey(e)}else this._destroyKey(this.key)},r.prototype._destroyKey=function(r){var i,s;if(!this.fn_ref){n.keypath(this.owner,r,null);return}i=n.keypath(this.owner,r);if(!i)return;s=t.$(i);if(n.isFunction(this.fn_ref))this.fn_ref.apply(this.owner,[s].concat(this.args?this.args.slice():[]));else{if(e.DEBUG&&!n.isFunction(s[this.fn_ref]))throw new Error("Mixin.AutoMemory: function '"+this.fn_ref+"' missing for wrapped property '"+r+"' on '"+n.classOf(this.owner)+"'");s[this.fn_ref].apply(s,this.args)}return n.keypath(this.owner,r,null)},r}(),e.AutoMemory.Function=function(){function t(t,r,i){this.object=t,this.fn_ref=r,this.args=i;if(!e.DEBUG)return this;if(!this.fn_ref)throw new Error("Mixin.AutoMemory: missing fn_ref");if(!n.isFunction(this.fn_ref)&&!(this.object&&n.isString(this.fn_ref)&&n.isFunction(this.object[this.fn_ref])))throw new Error("Mixin.AutoMemory: unexpected function reference")}return t.prototype.destroy=function(){if(!this.object){this.fn_ref.apply(null,this.args);return}if(!n.isFunction(this.fn_ref)){this.object[this.fn_ref].apply(this.object,this.args);return}return this.fn_ref.apply(this.object,[this.object].concat(this.args?this.args.slice():[]))},t}(),e.AutoMemory._mixin_info={mixin_name:"AutoMemory",initialize:function(){return e.instanceData(this,"AutoMemory",[])},destroy:function(){var t,n,r,i;n=e.instanceData(this,"AutoMemory"),e.instanceData(this,"AutoMemory",[]);for(r=0,i=n.length;r<i;r++)t=n[r],t.destroy()},mixin_object:{autoProperty:function(t,n){var r;return r=new e.AutoMemory.Property(this),r.setArgs.apply(r,arguments),e.instanceData(this,"AutoMemory").push(r),this},autoWrappedProperty:function(n,r,i){return i||(i=t.$),e.instanceData(this,"AutoMemory").push(new e.AutoMemory.WrappedProperty(this,n,r,i)),this},autoFunction:function(t,n){return e.instanceData(this,"AutoMemory").push(new e.AutoMemory.Function(t,n,Array.prototype.slice.call(arguments,2))),this}}},e.registerMixin(e.AutoMemory._mixin_info),e})}).call(this);